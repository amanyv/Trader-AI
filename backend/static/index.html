<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trader AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ðŸ”’ YOUR UI â€” UNCHANGED */
:root {
  --bg:#0b0f1a;--card:#12182b;--primary:#4f7cff;
  --text:#e6e9f0;--muted:#9aa4bf;
  --danger:#ff6b6b;--success:#4ade80;
}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:radial-gradient(circle at top,#111836,var(--bg));color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:40px 16px}
.app{width:100%;max-width:820px}
.header{text-align:center;margin-bottom:28px}
.card{background:linear-gradient(180deg,#151c35,var(--card));border-radius:14px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.4)}
.form{display:grid;grid-template-columns:1fr 1fr auto;gap:12px}
input{background:#0f1430;border:1px solid rgba(255,255,255,.1);color:var(--text);padding:14px;border-radius:10px}
button{background:linear-gradient(135deg,var(--primary),#6f8cff);border:none;color:#fff;font-weight:600;padding:0 22px;border-radius:10px}
.result{margin-top:22px;display:none}
.section{margin-top:16px}
.trade-box{background:#0f1430;border-radius:12px;padding:14px}
.kv{display:grid;grid-template-columns:140px 1fr}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <h1>Trader AI</h1>
    <p>AI-powered trading research</p>
  </div>

  <div class="card">
    <div class="form">
      <input id="symbol" placeholder="RELIANCE" />
      <input id="horizon" placeholder="2â€“3 weeks" />
      <button id="btn">Analyze</button>
    </div>

    <div id="result" class="result"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("JS READY");

  const btn = document.getElementById("btn");
  const symbolInput = document.getElementById("symbol");
  const horizonInput = document.getElementById("horizon");
  const resultEl = document.getElementById("result");

  let chart = null;

  btn.addEventListener("click", async () => {
    console.log("ANALYZE CLICKED");

    const symbol = symbolInput.value.trim();
    const horizon = horizonInput.value.trim() || "1";

    if (!symbol) {
      alert("Enter symbol");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Analyzingâ€¦";

    try {
      // ---------- ANALYZE ----------
      const res = await fetch("/api/analyze-symbol", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symbol, horizon })
      });

      if (!res.ok) {
        throw new Error("Analyze API failed");
      }

      const data = await res.json();
      console.log("ANALYSIS DATA", data);

      renderResult(data);
    } catch (e) {
      console.error(e);
      alert("Analyze failed â€“ check console");
    } finally {
      btn.disabled = false;
      btn.textContent = "Analyze";
    }
  });

  function renderResult(d) {
    resultEl.innerHTML = `
      <div class="section">
        <h3>Price Chart</h3>
        <canvas id="priceChart" height="140"></canvas>
      </div>

      <div class="section">
        <h3>Summary</h3>
        <div>${d.summary || "-"}</div>
      </div>

      <div class="section">
        <h3>Trade Idea</h3>
        <div class="trade-box">
          <div class="kv"><div>Direction</div><div>${d.trade_idea.direction}</div></div>
          <div class="kv"><div>Entry</div><div>${d.trade_idea.entry_zone}</div></div>
          <div class="kv"><div>Stop</div><div>${d.trade_idea.stop_loss}</div></div>
          <div class="kv"><div>Target</div><div>${d.trade_idea.target}</div></div>
        </div>
      </div>
    `;

    resultEl.style.display = "block";
    drawChart(d.symbol, d.trade_idea, horizonInput.value);
  }

  async function drawChart(symbol, trade, horizon) {
    const res = await fetch(
      `/api/price-data?symbol=${encodeURIComponent(symbol)}&horizon=${encodeURIComponent(horizon || "1")}`
    );

    if (!res.ok) {
      console.warn("Price API failed");
      return;
    }

    const data = await res.json();
    if (!data.prices || data.prices.length === 0) {
      console.warn("No price data");
      return;
    }

    const labels = data.prices.map(p => p.time);
    const prices = data.prices.map(p => p.close);

    const toNum = v => {
      if (!v) return null;
      const n = parseFloat(v.toString().split("-")[0]);
      return isNaN(n) ? null : n;
    };

    const entry = toNum(trade.entry_zone);
    const stop = toNum(trade.stop_loss);
    const target = toNum(trade.target);

    const ctx = document.getElementById("priceChart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Price",
            data: prices,
            borderColor: "#4f7cff",
            backgroundColor: "rgba(79,124,255,0.25)",
            fill: true,
            tension: 0.35,
            pointRadius: 0
          },
          entry && {
            label: "Entry",
            data: prices.map(() => entry),
            borderColor: "#facc15",
            borderDash: [6,6],
            pointRadius: 0
          },
          stop && {
            label: "Stop",
            data: prices.map(() => stop),
            borderColor: "#ff6b6b",
            borderDash: [6,6],
            pointRadius: 0
          },
          target && {
            label: "Target",
            data: prices.map(() => target),
            borderColor: "#4ade80",
            borderDash: [6,6],
            pointRadius: 0
          }
        ].filter(Boolean)
      },
      options: {
        plugins: {
          legend: {
            labels: { color: "#9aa4bf" }
          }
        },
        scales: {
          x: {
            ticks: { color: "#6b7395" },
            grid: { display: false }
          },
          y: {
            ticks: { color: "#6b7395" },
            grid: { color: "rgba(255,255,255,0.05)" }
          }
        }
      }
    });
  }
});
</script>
</body>
</html>
